\documentclass[12pt,a4paper]{memoir}

% General packages

\usepackage[left=2cm,right=2cm,top=2cm,bottom=2.5cm,footnotesep=1cm]{geometry}
\usepackage[utf8]{inputenc}
\usepackage[T1]{fontenc}
\usepackage{lmodern}
\usepackage{amsmath}
\usepackage{amsfonts}
\usepackage{amssymb}
\usepackage{gensymb}
\usepackage{graphicx}
\usepackage{colortbl}
\usepackage[usenames,dvipsnames,svgnames,table]{xcolor}
\definecolor{Prune}{RGB}{99,0,60}
\usepackage[framemethod=tikz]{mdframed}
\usepackage{multirow} %% Pour mettre un texte sur plusieurs rang√©es
\usepackage{multicol} %% Pour mettre un texte sur plusieurs colonnes
\usepackage{scrextend} %Forcer la 4eme  de couverture en page pair
\usepackage{fancyhdr}
\usepackage{multicol,multirow}
\usepackage{calc}
\usepackage{pifont}
\usepackage{adjustbox}
\usepackage{subfiles}
\usepackage[justification=centering]{caption}
\usepackage{calc,graphicx,soul,fourier,lipsum}
\usepackage{chngcntr}
%\counterwithin*{chapter}{part}

\graphicspath{{fig/}{./1_Introduction/fig/}{./2_T2K/fig/}{./3_HNL/fig/}{./4_upgrade/fig/}{./4_upgrade/fig/TPC/}{./4_upgrade/fig/general/}{./4_upgrade/fig/sfgd/}{./couverture_these_janv_aout_2020/}{./}}
\DeclareGraphicsExtensions{.png, .pdf, .jpg}

\newcommand{\todo}[1]{\textcolor{red}{#1}}

% TOC stuff
% suppress page number in toc for parts
\cftpagenumbersoff{part}
% Part offset in TOC
\setlength{\cftpartindent}{6cm}
% Rome number and part title separation
\renewcommand\cftpartnumwidth{1cm}
\renewcommand\cftpartname{}

% Add a line at header
\makeheadrule{headings}{\textwidth}{\normalrulethickness}

% Allow hyphenation
\usepackage[shortcuts]{extdash}

% Referencing and links
\usepackage{hyperref}
\hypersetup{
	colorlinks=true,
	linktocpage=true,
	citecolor=YellowOrange,
	linkcolor=violet,
	urlcolor=MidnightBlue!50!Aquamarine,
}

% Spacing
\setlength{\epigraphwidth}{.6\textwidth}
\frenchspacing
\usepackage[absolute]{textpos}
\usepackage{enumitem}
\setlist[itemize]{topsep=0.6em,itemsep=0.3em}
\setlist[description]{leftmargin=0.3em}
\setlist[description]{itemindent=0.6em}

% Prevent orphans (line beginning at end of a page) and widows (line ending at begin of a page)
\clubpenalty=10000
\widowpenalty=10000
\raggedbottom
\interfootnotelinepenalty=10000 % prevent footnotes on several pages

% bclogo blocks
\usepackage[tikz]{bclogo}
\renewcommand\bcStyleTitre[1]{\textbf{#1}}

% Tikz
\usepackage{tikz}
\usetikzlibrary{shapes}
\usetikzlibrary{calc,positioning,shadows.blur,decorations.pathreplacing}
\usepackage{etoolbox}
\tikzset{%
        brace/.style = { decorate, decoration={brace, amplitude=5pt} },
       mbrace/.style = { decorate, decoration={brace, amplitude=5pt, mirror} },
        label/.style = { black, midway, scale=0.5, align=center },
     toplabel/.style = { label, above=.5em, anchor=south },
    leftlabel/.style = { label,rotate=-90,left=.5em,anchor=north },
  bottomlabel/.style = { label, below=.5em, anchor=north },
        force/.style = { rotate=-90,scale=0.4 },
        round/.style = { rounded corners=2mm },
       legend/.style = { right,scale=0.4 },
        nosep/.style = { inner sep=0pt },
   generation/.style = { anchor=base }
}

% linenumbers
\usepackage{lineno}


% Tikz: particle table
\newcommand\particle[7][white]{%
  \begin{tikzpicture}[x=1cm, y=1cm]
    \path[fill=#1,blur shadow={shadow blur steps=5}] (0.1,0) -- (0.9,0)
        arc (90:0:1mm) -- (1.0,-0.9) arc (0:-90:1mm) -- (0.1,-1.0)
        arc (-90:-180:1mm) -- (0,-0.1) arc(180:90:1mm) -- cycle;
    \ifstrempty{#7}{}{\path[fill=purple!50!white]
        (0.6,0) --(0.7,0) -- (1.0,-0.3) -- (1.0,-0.4);}
    \ifstrempty{#6}{}{\path[fill=green!50!black!50] (0.7,0) -- (0.9,0)
        arc (90:0:1mm) -- (1.0,-0.3);}
    \ifstrempty{#5}{}{\path[fill=orange!50!white] (1.0,-0.7) -- (1.0,-0.9)
        arc (0:-90:1mm) -- (0.7,-1.0);}
    \draw[\ifstrempty{#2}{dashed}{black}] (0.1,0) -- (0.9,0)
        arc (90:0:1mm) -- (1.0,-0.9) arc (0:-90:1mm) -- (0.1,-1.0)
        arc (-90:-180:1mm) -- (0,-0.1) arc(180:90:1mm) -- cycle;
    \ifstrempty{#7}{}{\node at(0.825,-0.175) [rotate=-45,scale=0.2] {#7};}
    \ifstrempty{#6}{}{\node at(0.9,-0.1)  [nosep,scale=0.17] {#6};}
    \ifstrempty{#5}{}{\node at(0.9,-0.9)  [nosep,scale=0.2] {#5};}
    \ifstrempty{#4}{}{\node at(0.1,-0.1)  [nosep,anchor=west,scale=0.25]{#4};}
    \ifstrempty{#3}{}{\node at(0.1,-0.85) [nosep,anchor=west,scale=0.3] {#3};}
    \ifstrempty{#2}{}{\node at(0.1,-0.5)  [nosep,anchor=west,scale=1.5] {#2};}
  \end{tikzpicture}
}


\settocdepth{subsection}
\setsecnumdepth{subsubsection}
\renewcommand{\thepart}{\Roman{part}}
\renewcommand{\thechapter}{\arabic{chapter}}
\renewcommand{\thesection}{\arabic{section}}
\renewcommand{\thesubsection}{\arabic{section}.\arabic{subsection}}
\renewcommand{\thesubsubsection}{\arabic{section}.\arabic{subsection}.\alph{subsubsection}}


% Chapter heading
\usepackage{color,soul}
\definecolor{nicered}{rgb}{.255,.363,.622}
\makeatletter
\newlength\dlf@normtxtw
\setlength\dlf@normtxtw{\textwidth}
\def\myhelvetfont{\def\sfdefault{mdput}}
\newsavebox{\feline@chapter}
\newcommand\feline@chapter@marker[1][4cm]{%
    \sbox\feline@chapter{%
        \resizebox{!}{#1}{\fboxsep=1pt%
        \colorbox{nicered}{\color{white}\bfseries\rmfamily\thechapter}%
    }
}%
\rotatebox{90}{%
    \resizebox{%
        \heightof{\usebox{\feline@chapter}}+\depthof{\usebox{\feline@chapter}}
    }%
    {!}{\scshape\so\@chapapp}}\quad%
    \raisebox{\depthof{\usebox{\feline@chapter}}}{\usebox{\feline@chapter}}%
}
\newcommand\feline@chm[1][4cm]{%
\sbox\feline@chapter{\feline@chapter@marker[#1]}%
\makebox[0pt][l]{% aka \rlap
\makebox[1cm][r]{\usebox\feline@chapter}%
}}
\makechapterstyle{daleif1}{
\renewcommand\chapnamefont{\normalfont\Large\scshape\raggedleft\so}
\renewcommand\chaptitlefont{\normalfont\huge\bfseries\scshape\color{nicered}}
\renewcommand\chapternamenum{}
\renewcommand\printchaptername{}
\renewcommand\printchapternum{\null\hfill\feline@chm[2.5cm]\par}
\renewcommand\afterchapternum{\par\vskip\midchapskip}
\renewcommand\printchaptertitle[1]{\chaptitlefont\raggedleft ##1\par}
}
\makeatother
\chapterstyle{daleif1}

% Head of the section

\usepackage{titlesec}
%\definecolor{colSec}{RGB}{0, 0, 255}
%\definecolor{colSSec}{RGB}{0,173,239}
%\definecolor{colSSSec}{RGB}{0,173,239}
\colorlet{colSec}{MidnightBlue}
\colorlet{colSSec}{Bittersweet}
\colorlet{colSSSec}{Black}

  \newcommand\boxedSection[3]{{
      \begin{tikzpicture}[inner sep=#3,line width=1.5pt]
          \node[anchor=east,rectangle,draw,fill=colSec] at (0,0) (counter) {\color{white}\hspace*{2ex}\textbf{#2}};
              \draw (counter.south west) ++(.0pt,.5pt)-- ++($(\linewidth,0) - (2.5pt,0)$);
 \node [right of=counter,anchor=west]{\color{black}#1};
      \end{tikzpicture}
  }}

  \newcommand\boxedSubSection[3]{{
      \begin{tikzpicture}[inner sep=#3,line width=1.5pt]
          \node[anchor=east,rectangle,draw,fill=colSSec] at (0,0) (counter) {\color{white}\textbf{#2}};
              \draw (counter.south west)  ++(.0pt,.5pt)-- ++($(\linewidth,0) - (2.5pt,0)$);
 \node [right of=counter,anchor=west]{\hspace*{-0.5ex}\color{black}#1};
      \end{tikzpicture}
  }}

  \newcommand\boxedSubSubSection[3]{{
      \begin{tikzpicture}[inner sep=#3,line width=1.0pt]
          \node[anchor=center,diamond,draw,fill=colSSSec] at (0,0) (counter) {\color{white}\textbf{#2}};
             \draw (counter.south) ++(.0pt,4pt)-- ++($(\linewidth,0) - (2.5pt,0)$);
     \node [right of=counter,anchor=west]{\hspace*{-2ex}#1};
      \end{tikzpicture}
  }}

 \newcommand\boxedsection[1]{\boxedSection{#1}{\thesection}{2mm}}
 \newcommand\boxedsubsection[1]{\boxedSubSection{#1}{\thesubsection}{1.7mm}}
 \newcommand\boxedsubsubsection[1]{\boxedSubSubSection{#1}{\alph{subsubsection}}{0.7mm}}

  \titleformat{\section}[hang]%
      {\Large\bfseries}%
      {}%
      {.0em}%
      {\filright\boxedsection}%
  \titlespacing{\section}
	  {0pc}{-1ex}{-2ex}

  \titleformat{\subsection}[hang]%
      {\large\bfseries}%
      {}%
      {.0em}%
      {\filright\boxedsubsection}%99
  \titlespacing{\subsection}
	  {0pc}{-1ex}{-2ex}

  \titleformat{\subsubsection}[hang]%
      {\normalsize\bfseries}%
      {}%
      {.0em}%
      {\filright\boxedsubsubsection}%
  \titlespacing{\subsubsection}
	  {0pc}{0ex}{0ex}

\usepackage[
sorting=none,
citestyle=numeric,
]{biblatex}
\addbibresource{bib_main.bib}

\DeclareSourcemap{
  \maps[datatype=bibtex]{
    \map[overwrite]{
      \step[fieldsource=doi, final]
      \step[fieldset=url, null]
      \step[fieldset=eprint, null]
      \step[fieldset=issn, null]
    }
    \map[overwrite]{
      \step[fieldsource=eprint, final]
      \step[fieldset=url, null]
    }
  }
}


% \title{Search for heavy neutrinos in the T2K experiment and upgrade of the near detector ND280}
% \author{Suvorov Sergey}
% \date{July 2020}

\DeclareMathAlphabet{\mathcal}{OMS}{cmsy}{m}{n}

\begin{document}

\subfile{./couverture_these_janv_aout_2020/Modele_These_UParisSaclay_2020.tex}

% \maketitle
\clearpage
\tableofcontents*
% \linenumbers

% Part references
\subfile{./1_Introduction/main.tex}
\subfile{./2_T2K/main.tex}
\subfile{./3_HNL/main.tex}
\subfile{./4_upgrade/main.tex}
\subfile{./summary.tex}

\printbibliography
\cleartoverso
\thispagestyle{empty}
\subfile{./couverture_these_janv_aout_2020/abstract.tex}

\end{document}
